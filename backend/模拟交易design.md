# 股票模拟交易与回测系统设计文档 (Stock Simulation Design Doc)

## 1. 设计目标
本系统旨在建立一个严谨的、基于数据的 AI 投资决策实验平台。Agent 不仅仅是一个简单的对话机器人，而是一个模拟的“基金经理”，需要根据多维度数据进行理性的投资决策。

## 2. 核心架构：多因子决策模型 (Multi-Factor Decision Model)
为了保证决策的科学性，Agent 将基于四大维度进行分析：

### 2.1 输入层：信息集 (The Information Set)
在每次模拟运行（如每日收盘）时，我们将聚合以下数据上下文：

#### A. 技术面分析 (Technical Analysis) - 择时
*数据来源：历史行情数据 (30-60天)*
*   **趋势 (Trend)**: 均线系统 (MA5, MA20, MA60)。判断当前是主要趋势是向上、向下还是震荡。
*   **动量 (Momentum)**: RSI (相对强弱指标)。判断是否超买 (>70) 或超卖 (<30)。
*   **信号 (Signal)**: MACD (金叉/死叉)。
*   **波动 (Volatility)**: 布林带 (Bollinger Bands)。当前价格相对于上下轨的位置。

#### B. 基本面分析 (Fundamental Analysis) - 择股
*数据来源：财报数据工具*
*   **估值 (Valuation)**: 市盈率 (PE TTM), 市净率 (PB)。判断股价是否低估。
*   **成长 (Growth)**: 营收增长率 (Revenue Growth), 净利润。企业是否在扩张。
*   **财务健康**: 负债率 (Debt-to-Equity)。

#### C. 市场环境 (Market Context) - 风控
*数据来源：宏观数据工具*
*   **风险偏好**: VIX 指数 (恐慌指数)。
*   **宏观背景**: 十年期美债收益率 (无风险利率)。

#### D. 舆情与情绪 (News & Sentiment) - 催化剂
*数据来源：新闻搜索 + FinBERT 模型*
*   **新闻**: 过去 24 小时内的 Top 3-5 条相关新闻。
*   **情绪分**: 对新闻标题/摘要进行 NLP 情感分析 (正面/中性/负面)。

---

### 2.2 推理层：思维链 (Reasoning Engine)
Agent 将被设定为“严谨的基金经理”人设，执行分步推理：

1.  **技术面评分 (0-10)**: "价格站上 MA20，但 RSI 显示超买，评分 6。"
2.  **基本面评分 (0-10)**: "估值偏低，成长性好，评分 8。"
3.  **情绪面评分 (0-10)**: "刚刚发布利好新闻，评分 9。"
4.  **宏观面评分 (0-10)**: "市场恐慌情绪上升，需谨慎，评分 4。"
5.  **综合决策**: 根据权重加权，得出最终操作建议。

### 2.3 输出层：交易指令 (Execution)
Agent 必须输出严格的 JSON 格式：
*   **Action**: `BUY` (买入), `SELL` (卖出), `HOLD` (观望)。
*   **Quantity**: 交易数量 (需结合当前资金或持仓)。
    *   *风控约束*: 单笔交易不超过总资产的 20% (由代码强制执行或 Prompt 约束)。
*   **Reason**: 简短的决策理由（用于日志展示）。

## 3. 实现计划
1.  **数据聚合器 (Data Aggregator)**: 开发 Python 服务，一次性拉取上述所有数据，生成 `MarketState` 对象。
2.  **Prompt 模板**: 设计结构化 Prompt，将 `MarketState` 转化为 LLM 可读的上下文。
3.  **Agent 交互**: 调用 LLM 并解析返回的 JSON。
4.  **执行与反馈**: 模拟撮合交易，更新持仓状态。
