# AI Agent 执行规范 (AGENTS.md) v2.1

## 🔴 核心禁令 (Critical Restrictions)
1.  **禁止直接运行代码**：严禁使用 `go run`, `npm start`, `python main.py` 等命令直接运行源码。
2.  **禁止直接执行构建/测试**：严禁直接使用 `go build`, `npm build`, `go test` 等命令（除非用户明确要求运行特定的 CI 脚本）。
3.  **验证手段限制**：代码验证**仅允许**使用 **Lint 工具** (如 `golangci-lint`, `eslint`) 和 **Format 工具** (如 `go fmt`, `prettier`) 进行静态分析和格式化。
4.  **禁止幻觉上下文**：在生成 Prompt 之前，必须通过**阅读源码**或**搜索引擎**获取真实上下文，禁止凭空假设。
5.  **禁止抢跑 (No Pre-execution)**：在用户确认《执行计划》之前，**严禁**开始编写或修改任何业务代码。

---

## 一、 标准作业流程 (SOP)

### 阶段一：Prompt 优化与架构规划 (Requirement Analysis)
**(目标：明确需求，达成共识)**

**执行逻辑**：
1.  **Context Gathering (信息收集)**：
    *   阅读相关源码文件，理解现有架构、变量命名和依赖。
    *   如遇未知技术或库，调用搜索工具查询最新文档。
2.  **Drafting (方案起草)**：
    *   基于收集到的信息，构建结构化的 Prompt。
    *   **判断复杂度**：如果涉及核心架构变更或多模块修改，标记为需要进入 [Spec 流程](#三-复杂任务-spec-流程)。
3.  **Optimization Output (输出优化结果)**：
    *   **必须**按照下方《结构化 Prompt 模板》输出，并等待用户确认。

#### 📋 结构化 Prompt 输出模板
```markdown
# 🛡️ 任务执行方案 (Prompt Proposal)

## 1. 角色设定 (Role)
> **身份**: [例如：资深 Golang 后端专家]
> **基调**: 严谨、遵循 Clean Code、注重性能与安全。

## 2. 上下文分析 (Context & Facts)
- **已阅文件**: `[文件列表]`
- **项目现状**: [简述架构/框架/现状]
- **关键约束**: [例如：禁止破坏现有 API 签名]

## 3. 任务目标 (Objectives)
- [ ] 核心功能: [具体描述]
- [ ] 质量要求: Lint/Fmt 通过。

## 4. 预估影响 (Impact)
- **修改范围**: [预估涉及的文件]
- **潜在风险**: [例如：可能导致接口不兼容]

---
**请确认**: [同意并生成计划] / [修改方案] / [拒绝]
```

---

### 阶段二：生成执行计划 (Execution Planning)
**(目标：拆解任务，确认路径。🔴 此阶段禁止写代码)**

**触发条件**：用户在第一阶段回复“同意”或类似确认指令。

**执行逻辑**：
1.  **任务拆解**：将任务目标拆解为可独立执行的原子步骤（Steps）。
2.  **文档生成**：输出一份 Markdown 格式的《执行计划文档》，**并必须以文件形式保存到项目目录**。
3.  **等待确认**：输出计划后，**必须停止操作**，询问用户是否按此执行。

#### 📝 执行计划文档模板 (Plan Template)

```markdown
# 🚀 执行计划 (Execution Plan)

## 🎯 最终交付物
[简述任务完成后的状态]

## 🗓️ 步骤清单 (Checklist)
> 说明：每一步完成后，我会自动勾选并更新此列表。

- [ ] **Step 1: 准备工作/定义接口**
    - [ ] 动作: 创建/修改 `[文件A]`。
    - [ ] 验证: 运行 `go fmt`。
- [ ] **Step 2: 核心逻辑实现**
    - [ ] 动作: 实现 `[功能模块]` 逻辑。
    - [ ] 验证: 运行 `golangci-lint`。
- [ ] **Step 3: 调用侧适配与清理**
    - [ ] 动作: 修改 `[调用方文件]`。
    - [ ] 验证: 全局静态检查通过。

---
**请确认**: 输入 **"Y"** 开始执行 Step 1，或输入修改意见。
```

---

### 阶段三：逐步执行与迭代 (Step-by-Step Execution)
**(目标：稳步推进，步步为营)**

**触发条件**：用户确认执行计划 (输入 "Y")。

**执行逻辑 (循环)**：

1.  **锁定当前步骤**：识别计划中第一个未完成（`[ ]`）的主要任务。
2.  **执行编码 (Coding)**：
    *   根据步骤描述，使用代码工具修改指定文件。
    *   **必须遵守** [代码验证规范](#二-代码验证规范-verification) 进行检查。
3.  **更新计划 (Update Plan)**：
    *   ✅ **若成功**：输出代码内容，并将该步骤标记为 `[x]`。
    *   ❌ **若失败**：保持 `[ ]`，报告错误日志，并尝试修复。
4.  **循环输出**：
    *   **每完成一个步骤**，必须重新输出更新后的《执行计划文档》。
    *   **自动暂停**（可选）：如果任务风险较高，每步完成后询问“是否继续”。

**循环终止**：当所有 Checkbox 均为 `[x]` 时，进入[最终交付](#五-最终交付)。

---

## 二、 代码验证规范 (Verification)

**原则**：代码修改完成后，**严禁运行程序**，必须执行以下静态检查。

1.  **格式化 (Formatting)**:
    *   Go: `go fmt ./...`
    *   JS/TS: `prettier --write .`
    *   Python: `black .`
2.  **静态分析 (Linting)**:
    *   Go: `golangci-lint run ./...`
    *   JS/TS: `eslint .`
    *   其他: 使用项目配置的 lint 工具。
3.  **结果处理**:
    *   ❌ **Lint 报错**: **必须修复**（这是代码不可用的强信号）。
    *   ⚠️ **Lint 警告**: 评估后修复。
    *   ✅ **通过**: 视为当前步骤代码层面完成。

---

## 三、 复杂任务 Spec 流程 (Spec Mode)

**触发条件**：
- 修改涉及 >3 个文件。
- 涉及数据库 Schema 或核心 API 变更。

**执行步骤**：
1.  **输出设计文档**：创建 `SPEC_TASK_xxx.md`（含接口定义、ER图）。
2.  **用户评审**：等待确认。
3.  **转化计划**：**将确认后的 Spec 转化为《阶段二：执行计划文档》**，然后进入标准流程。

---

## 四、 异常处理与回退

1.  **Lint 无法修复**：
    *   若遇到底层依赖冲突或无法解决的 Lint 错误。
    *   **停止操作**，在计划文档中将该步骤标记为 **[BLOCK]**，向用户报告。
2.  **计划变更**：
    *   执行中发现原计划不可行。
    *   **停止执行**，输出新的《执行计划文档》请求用户重新确认。

---

## 五、 最终交付

1.  **清理现场**: 删除生成的临时文件。
2.  **全量检查**: 运行一次全项目 Lint 确保无引入新问题。
3.  **结束标识**: 输出最终的全勾选计划表，并输出：
    > "🎉 任务执行完毕，所有步骤已验证通过！"

---

**更新日志 (2025-11-29)**:
- v2.1: 引入“计划确认 -> 逐步执行”工作流，增加《执行计划文档》作为强制中间件。
- v2.0: 确立“严禁运行，仅限 Lint”的核心原则。